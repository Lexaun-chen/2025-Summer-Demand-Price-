### 因子：订单价格分歧程度因子
#### 定义：
```math
订单加权平均对数价格 = \frac{\sum \ln(订单价格) \cdot 订单委托量}{\sum 订单委托量}    
```
```math
订单绝对价格分歧程度 = \sqrt{\frac{\sum \left[ \ln(订单价格) - 订单加权平均对数价格 \right]^2 \cdot 订单委托量}{\sum 订单委托量}}
```

<details>
<summary>研报重点信息摘录</summary>    

1. 因子构建逻辑：
         
         在未区分买卖方向的情况下，该因子为区间内订单价格的委托量加权平均标准差

         订单价格 = 投资者对股票价值的判断 -> 订单价格的分歧程度 = 投资者对股票价值判断的分歧程度
         
         A股市场缺乏完善做空机制：价格分歧加剧 -> 多空双方博弈 -> 悲观观点无法充分表达 -> 短时间内价格被高估 -> 后期价格回落导致收益较差   

2. 研报结果：该因子呈现出显著的反向预测特性，分歧程度越小的股票平均表现更好，分歧程度越大的股票未来收益率越低
</details>

<details>
<summary>初步复现结果（未负向）</summary>

</details>

<details>
<summary>可解释性分析</summary>    

1. 多头端（高分歧度）表现不佳
- 行为金融学 Miller原理        
   A股市场缺乏完善做空机制，存在做空限制。价格分歧加剧 -> 多空双方博弈 -> 悲观观点无法充分表达 -> 短时间内价格被高估 -> 后期价格回落后收益较差   
      
- 市场微观角度    
   高分歧可能说明了市场上信息不对称性,知情者与不知情者对该股价值判断存在系统性偏差    

2. 空头端（低分歧度）表现优异
- 行为金融学与信息效率    
   参与者对股票价值判断具有高度共识 -> 信息质量高 -> 被价格完全反映,价格有效性高 -> 收益率合理

</details>  

#### 初步改进：区分早盘与盘中
将订单委托时间分为早盘(<93000000)和盘中(93000000 <= order_time <145700000)两部分,分别构造因子    

<details>
<summary>主要结果</summary>
将订单委托时间分为早盘(<93000000)和盘中(93000000 <= order_time <145700000)两部分,分别构造因子    


![image](/uploads/84ae8ee3615cc278fce0f7bb4de8c0de/image.png)



</details>

#### 进一步改进：细化时间段划分并且区分买卖方向 （已负向）

- 说明：订单价格分歧度通过标准差计算，因子值全为正，反向后因子后值越大（越接近0），组别越高代表原始分歧度越小。

- 改进逻辑：

     -- 初步改进中两时间段分组收益率表现差异较大，说明不同时间段投资者交易风格不同。

     -- 区分买卖方向，探究买方与卖方的分歧度（交易风格）是否有本质性差异。

- 具体操作：把每天的数据按买卖方向和6个时间段划分为12个类型，分别测试，下面分买卖方进行讨论。     

- 6个时间段： 9:15-9:20  \ 9:20-9:25  \  9:30-10:00   \  10:00-14:30   \  14:30-14:57  \   14:57-15:00     

结果总结：**买方表现明显优于卖方。两方分组收益单调性一致，说明分歧度因子反应的收益与买卖意愿关系不大，而与波动率关系更大， 推翻了原研报中从A股的做空限制来解释因子的逻辑.** 

##### 卖方
<details>
<summary>主要结果</summary>

- 卖方效果较好的几个因子集中在尾盘附近，分别是 14:30-14:57  14：57-15：00
    
![image](/uploads/42ca55f5849684023d55aad2207ea2f0/image.png)
![image](/uploads/a0933d5f1d2304299cab94547d714c5f/image.png)

- 10:00-14:30的主交易时间段多头端表现比较好，但多空曲线波动较大    

![image](/uploads/f39cb2ddb0a74921b51e5239c5a2ea5c/image.png)

- 早盘附近的表现会差很多
![image](/uploads/5691900cce8c7791cc08c2640784405a/image.png)
![image](/uploads/7334d9379710d2b2e929ffa59ee577be/image.png)
</details>


##### 买方
<details> 
<summary>早盘</summary>
早盘里细分的三个时间段，除了最开始可以撤单的时间多空曲线波动较大之外，其他两个看起来都不错。
![image](/uploads/82a43127e74a9f56be52b060a137da04/image.png)
![image](/uploads/68fe16b0280ec5c010943fbccc2b8e36/image.png)
![image](/uploads/9da7c595155a10576c8efb599b355dee/image.png)
</details>

<details> 
<summary>连续竞价</summary>
连续竞价期间表现得也很稳定
![image](/uploads/ea14730a90654d48980eae945923120f/image.png)
</details>

<details> 
<summary>尾盘</summary>
尾盘也看着还行，只有最后集合竞价的时候不太好
![image](/uploads/60d135b3ec6a40a8667eaa992d90053b/image.png)
![image](/uploads/3920250729e644ceddc9b44fd736dce3/image.png)
</details>


### 问题探究：为什么因子与rv的相关性在中性化（含标准化操作）前后出现跳水现象    

1. 确认出现原因：通过手动中性化操作，发现标准化过程中的winsorize过程影响了因子值中的极值点，进而导致了rv的突变

2. 探究极值来源：即使有价格笼子限制，委托单数据依然噪音巨大，存在大量不合理的订单价格。

- ![image](/uploads/ff1efd102b967750f76d4642ff21ce4a/image.png)

- 随机选择2023-11-01 这一天看异常价格订单委托量分布情况

<details>
<summary>统计信息</summary>

- 异常值规定: 5%以下或95%以上       

| 指标 | 值 |
|------|-----|
| 分析的股票总数 | 5073 |
| 异常价格订单委托量平均占比 | 14.10% |
| 异常价格订单委托量中位数占比 | 13.64% |
| 低价异常订单委托量平均占比 | 5.83% |
| 高价异常订单委托量平均占比 | 8.27% |
| 异常价格订单数量平均占比 | 8.47% |

- 异常价格订单委托量在总委托量中的占比：

| 阈值 | 超过阈值的股票比例 |
|------|------------------|
| > 1% | 99.98% |
| > 5% | 98.56% |
| > 10% | 89.61% | 
| > 20% | 6.76% |
| > 30% | 0.34% |
| > 50% | 0.02% |
</details>

3. 尝试了不同的改进方式
- 改进一：直接对订单价格进行**去尾**操作 [p01,p99]
![image](/uploads/e83fde834af2a9bcefaf310d8c429d22/image.png)

- 改进二：以当日该股涨跌停价格作为界限，**替换**当日超出此范围的买单订单价格  
![image](/uploads/d4d410fd7dc0f70c46bacf6cdca8262d/image.png)   


**结论：直接去除订单价格中的极端值效果更为显著，但会损失一定信息。接下来，尝试把去尾改为尝试不同力度的缩尾，并探究这一操作的合理性**
