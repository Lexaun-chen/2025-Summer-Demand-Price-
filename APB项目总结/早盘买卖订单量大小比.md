### 因子：早盘买卖订单量大小比
#### 定义：
```math
\text{早盘买卖单大小比} = ln（\frac{\text{10: 30 前的买入订单平均委托量}}{\text{10: 30 前的卖出订单平均委托量}} ）
```

<details>
<summary>研报重点信息摘录</summary>    

1. 早盘区间： [93000000,103000000)     

2. 因子构建目的：
 
          刻画早盘时间段新增的订单情况 -> 获取不同投资者的买卖方向 -> 跟踪资金走向:当大资金买入时跟进，大资金卖出时退出

3. 研报结果：早盘买入订单更大的股票平均表现更好、卖出订单更大的股票表现更差
</details>

##### 初步复现结果
- 发现：short_rev的负相关性较高；空头反转效应极强
<img width="1120" height="798" alt="image" src="https://github.com/user-attachments/assets/19278749-1e0c-4d6a-9fad-699dd2bb4b54" />


<details>
<summary>直接中性化short_rev</summary> 
   
- 结果：对分组收益率影响较大，降低低位组的收益率，增加了高位组的收益率；反转效应依旧存在，高位各组收益基本呈单调性。    
- 猜测：因子与short_rev 负相关 -> 低位组为short_rev中的高位组，收益受益于short_rev，高位组为short_rev中的低位组，收益受short_rev反映的反转效应影响较大。

<img width="1129" height="797" alt="image" src="https://github.com/user-attachments/assets/5f05b34a-ac3b-44e9-a1fd-372edcb60c7e" />

</details>


### 初步改进
- 改进一：将每日的因子值和同时间段的收益率回归取残差

<details>
<summary>解释与结果</summary> 
   
- 改进逻辑：short_rev会较大程度影响分组收益，且对多空方影响方向不同，说明因子容易受短期收益率影响。A股市场反转效应较强，尝试直接同时间段的收益率回归取残差，剥离收益率影响。
- 结果：对分组收益率影响较大：降低低位组的收益率，增加了高位组的收益率；
<img width="1120" height="795" alt="image" src="https://github.com/user-attachments/assets/86ce98cc-b1f1-4b4b-b50b-855d839556e8" />

</details>

- 改进二：当日同时段发生过盘中涨跌停的个股因子值置为nan
<details>
<summary>解释与结果</summary> 
   
- 改进逻辑：涨跌停会大幅度影响买卖订单量的数量和分布，从而影响因子值。
- 结果：分组收益与原始结果基本保持一致，说明涨跌停股票影响较小。
<img width="1118" height="788" alt="image" src="https://github.com/user-attachments/assets/6da09817-6362-4c6e-84d6-02c0587a850d" />

</details>

#### 验证因子与同时段收益率的相关性与暴露度

**结论：按因子值分组后，各组的表现差异更像是随机波动，而非因子本身的预测能力。**

<details>
<summary>与同时段收益率：用未滚动过的每日因子</summary>

a. 相关性

<img width="1189" height="589" alt="image" src="https://github.com/user-attachments/assets/2fe954b1-991c-47df-a560-3af4415a6922" />


b. 各组内暴露度
<img width="1489" height="790" alt="image" src="https://github.com/user-attachments/assets/1bcc7830-d5fa-4b26-94f4-ce8b67fa68c8" />

<img width="1490" height="590" alt="image" src="https://github.com/user-attachments/assets/1f99f1a5-9c75-4e46-b18b-2448ef5e4578" />

</details>


<details>
<summary>与平滑过的short_reversal：用20d滚动过的每日因子</summary>

a. 相关性
<img width="1190" height="589" alt="image" src="https://github.com/user-attachments/assets/1b01a226-b968-4bf6-9352-2b671dd70d35" />

与short_reversal相关性也并不高。

b. 各组内暴露度
<img width="1489" height="790" alt="image" src="https://github.com/user-attachments/assets/06c4a8f2-276a-40f4-a312-9ee5184ecf78" />
<img width="1490" height="590" alt="image" src="https://github.com/user-attachments/assets/af62bd47-c87a-46ac-a067-0ada7027840b" />

</details>



### 进一步改进：构造方式     
#### 1. 从平均委托量改成总平均委托量     
<details>
<summary>结果</summary>
<img width="1126" height="798" alt="image" src="https://github.com/user-attachments/assets/85df3221-54c4-4802-b74e-00568e03615e" />

</details>



#### 2. 构造**净委托量**概念    

有如下两种构造方式：
```math
\text{早盘净委托量} = \text{Sign} *  ln（1 + \frac{\text{|10: 30 前的买入订单总委托量 - 10: 30 前的卖出订单总委托量|}}{\text{10: 30 前的买入订单总委托量 + 10: 30 前的卖出订单总委托量}} ） 
```
测试时间：2021-01-01 ~ 2025-12-31      
<img width="1126" height="798" alt="image" src="https://github.com/user-attachments/assets/3ccd53f5-02de-49ad-9a8b-c1d3a5b2eec3" />


```math
\text{早盘净委托量} = \frac{\text{10: 30 前的买入订单总委托量 - 10: 30 前的卖出订单总委托量}}{\text{10: 30 前的买入订单总委托量 + 10: 30 前的卖出订单总委托量}}  
```
测试时间：2021-01-01 ~ 2025-12-31      
<img width="1130" height="795" alt="image" src="https://github.com/user-attachments/assets/a9ac421e-c472-4157-ae68-941b0a9487a3" />


- 分时段进行全时间段测试：     
测试时间：2019-01-02 ~ 2025-5-31      
<details>
<summary> 9：30~10：30 </summary>
<img width="1126" height="784" alt="image" src="https://github.com/user-attachments/assets/f22db6b7-754e-475e-a32a-a2ff5b177d54" />

</details>
<details>
<summary> 9：30~10：00 </summary>
<img width="1126" height="788" alt="image" src="https://github.com/user-attachments/assets/38f6d9fd-9516-4139-bf30-a9ddd385986c" />

</details>
<details>
<summary> 10：00~10：30 </summary>
<img width="1125" height="796" alt="image" src="https://github.com/user-attachments/assets/13dd9b20-11be-4afe-978b-4c830bb276ef" />

</details>

#### 3.按百分比筛选大单    
以所有委托单量的90分位数作为threshold筛选大单子，对筛选出来的大单进一步区分买卖方向    


<details>
<summary> a. 早盘大单买卖订单大小比因子 </summary>
- SUM()
<img width="1130" height="796" alt="image" src="https://github.com/user-attachments/assets/94c902fc-46d2-467d-b792-7fa157deefaa" />

- AVG()
<img width="1123" height="795" alt="image" src="https://github.com/user-attachments/assets/1afc1cb3-d879-46c4-9743-83434ab87243" />

</details>


<details>
<summary> b. 净委托量 </summary>
<img width="1126" height="798" alt="image" src="https://github.com/user-attachments/assets/d5d572ce-e351-477c-85c8-9f9d57bdaf57" />

<img width="1125" height="795" alt="image" src="https://github.com/user-attachments/assets/6434689b-0ef2-463d-82a2-8176e67798d3" />

</details>
