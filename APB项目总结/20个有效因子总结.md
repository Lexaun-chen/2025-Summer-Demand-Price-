本报告中总结了如下20个因子的原始回测表现与20d滚动后回测表现,以及因子构造方式。       

1.缩尾订单价格分歧程度因子（8）   
  
- 每日时间段： 9：30 ~ 10：00；  10：00 ~ 14：30；    14：30 ~ 14：57       
- Bid Side：对订单价格进行\[P01, P99\]的缩尾
- Ask Side：对订单价格进行\[P03, P97\]的缩尾
- 买卖双方分钟频分歧度因子：9：30 ~ 14：57 


2. 基于主笔委托买方数据构建的APB 因子 （3）     

- 原始日频
- 分钟频降维为日频
- 跨日复权版5日均值


3. 分钟频因子与分钟频收益率的暴露度因子 （8）     

a. 分钟频\[P01,P99\]缩尾订单价格分歧度与分钟频收益率的分组切割因子     
- 买方：低分钟收益率组平均分钟价格分歧度；  高分钟收益率组平均分钟价格分歧度     
- 卖方：低分钟收益率组平均分钟分歧度； 高分钟收益率组平均分钟价格分歧度；  低价格分歧度组平均分钟收益率；  高价格分歧度组平均分钟收益率        

b. 分钟频\[P01,P99\]缩尾委托买单APB与分钟频收益率的分组切割因子       
- 高分钟apb组平均分钟收益率作为因子       
- 高分钟收益率组平均分钟APB作为因子       


4. 分钟频委托买单APB与分钟频收益率的相关性因子 （1）

[汇总因子比较性测试.pdf](https://github.com/user-attachments/files/21573812/default.pdf)



### A. 因子：缩尾订单价格分歧程度因子
#### 定义：
```math
订单加权平均对数价格 = \frac{\sum \ln(订单价格) \cdot 订单委托量}{\sum 订单委托量}    
```
```math
订单绝对价格分歧程度 = \sqrt{\frac{\sum \left[ \ln(订单价格) - 订单加权平均对数价格 \right]^2 \cdot 订单委托量}{\sum 订单委托量}}
```

#### Bid Side：对订单价格进行[P01, P99]的缩尾    

有效时间段：    
- 9：30 ~ 10：00     
1. 原始因子 
<img width="1125" height="795" alt="image" src="https://github.com/user-attachments/assets/3b01ffc0-0880-4309-b7a3-29ef168bf537" />

  
2. 20d滚动结果        
<img width="1130" height="795" alt="image" src="https://github.com/user-attachments/assets/be17dd22-d5c7-4c65-9726-1c37ccdaa23b" />

 
- 10:00 ~ 14：30    
1. 原始因子   
<img width="1125" height="795" alt="image" src="https://github.com/user-attachments/assets/1d613ee9-5a40-4e22-8c41-fe8c31ba2f24" />

2. 20d滚动结果    
<img width="1125" height="792" alt="image" src="https://github.com/user-attachments/assets/4cda7906-5f4a-42e0-b0b9-8db0f6501e78" />

- 14：30 ~ 14：57

1. 原始因子     
<img width="1127" height="791" alt="image" src="https://github.com/user-attachments/assets/94bcb2c7-029d-46c1-b0ea-2fa20c413585" />


2. 20d滚动结果   
<img width="1121" height="796" alt="image" src="https://github.com/user-attachments/assets/9cdff82a-e9c4-49bb-8ed7-30596233d735" />




#### Ask Side：对订单价格进行[P03, P97]的缩尾    

有效时间段：    
- 9：30 ~ 10：00    
1. 原始因子 
<img width="1128" height="797" alt="image" src="https://github.com/user-attachments/assets/f34e729c-ceb1-4adc-bc3a-f01bd467ebf4" />
    
2. 20d滚动结果    
<img width="1123" height="799" alt="image" src="https://github.com/user-attachments/assets/124719c1-41e5-4889-a0d6-a2928d66caad" />


- 10:00 ~ 14：30    
1. 原始因子 
<img width="1125" height="791" alt="image" src="https://github.com/user-attachments/assets/e66c1de2-8976-4abe-871e-8febd473bf57" />
 
2. 20d滚动结果    
<img width="1126" height="794" alt="image" src="https://github.com/user-attachments/assets/587bd0a1-0791-415b-8ccd-663c500804ab" />


- 14：30 ~ 14：57
1. 原始因子  
<img width="1127" height="796" alt="image" src="https://github.com/user-attachments/assets/f2d9eff7-1b2c-4675-b24a-29be913aa832" />

2. 20d滚动结果      
<img width="1127" height="787" alt="image" src="https://github.com/user-attachments/assets/1964321c-d781-4e3c-a65b-3695be3a6058" />



#### 分钟频分歧度因子

- 没有做连续交易时间段的筛选，订单数据中所有存在交易记录的分钟都被计入了，最后取日度均值；对买卖双方均采取了[P01, P99]的缩尾      
- order_minute 与日度均值计算方式如下：
```python
 DATE_TRUNC('minute', 
            ('{trading_date}'::DATE + MAKE_TIME(
                    FLOOR(order_time / 10000000)::int,
                    (FLOOR(order_time / 100000) % 100)::int,
                    (FLOOR(order_time / 1000) % 100)::numeric + 
                    (order_time % 1000)::numeric / 1000) 
            )::TIMESTAMP
                ) AS order_minute

daily_bid=df.groupby(['security_code'])['bid_price_divergence_p01p99'].mean().reset_index()
daily_ask=df.groupby(['security_code'])['ask_price_divergence_p01p99'].mean().reset_index()
```

1. 原始因子
<img width="1123" height="793" alt="image" src="https://github.com/user-attachments/assets/04d5034c-5d4c-46b9-a8b3-52231b14f977" />

<img width="1125" height="792" alt="image" src="https://github.com/user-attachments/assets/a129ea9f-2fb4-4e59-a5af-faffd26d6d47" />

2. 20d滚动结果
<img width="1127" height="797" alt="image" src="https://github.com/user-attachments/assets/4d2ce05b-af01-43a3-b68a-eec5d3920094" />

<img width="1125" height="798" alt="image" src="https://github.com/user-attachments/assets/1629b86b-b412-4d59-b1f3-ada19434d459" />






### 基于主笔委托买方数据构建的APB 因子 
- 订单时间：9：30 ~ 14：57  
- 统一对订单价格进行[P01, P99]的缩尾    
- order_type = '1'  AND order_type = 'A'  AND order_details = 'L'   
- 不同滚动窗口比较测试:
<img width="709" height="921" alt="image" src="https://github.com/user-attachments/assets/e3dcf601-f49b-46eb-a621-2c8110e9e53c" />


**综合来看构造的时候选择20天滚动效果会更好**

#### 定义：
```math
 区间内twap:区间内成交价格的简单平均；    
 区间内vwap:区间内成交量加权成交价格

```
```math
区间内 APB_{i} = \ln \left( \frac{twap_{i}}{vwap_{i}} \right)
```
### 本项中更改的是对区间的定义



#### A. 分钟频（区间为分钟）
- 用9：30 ~ 14：57 时间内所有订单数据，以分钟为划分计算各分钟APB，最后计算每只股票每日所有分钟频APB的简单平均作为当日因子值
- 1. Raw Factor
- 2. 20d Rolling
<img width="709" height="921" alt="image" src="https://github.com/user-attachments/assets/0ba43df0-121f-4d74-847e-1fe40ba81cbc" />


 
#### B. 日频 （区间为天）
- 用9：30 ~ 14：57  时间内所有订单数据，直接计算当日日度APB
- 1. Raw Factor 
           原始数据不小心被我删掉了QAQ    

- 2. 20d Rolling
<img width="1125" height="795" alt="image" src="https://github.com/user-attachments/assets/2a1d2f40-d20e-45eb-8d3b-baafbf319ad9" />



#### C. 5天均值日频 (区间为包括今天+过去4天，共5天）
- 对所有订单价格复权后，获取今天与过去四个交易日每天9：30 ~ 14：57 时间内所有订单数据，直接计算5dAPB,作为当日APB的值
- 为了节省计算速度，我选择线计算出每个交易日 total_volume, total_price, total_value，total_count等指标，利用复权表对其中的price与value项进行复权，最后再计算tvap与vwap

- 1. Raw Factor
- 2. 20d Rolling
<img width="1128" height="796" alt="image" src="https://github.com/user-attachments/assets/6b67a69b-0d31-404e-b9f5-b9743413faf1" />





### 分钟频因子与分钟频收益率的暴露度因子

#### 分钟频[P01,P99]缩尾订单价格分歧度与分钟频收益率的分组切割因子


##### 买方因子与收益率的关系分组结果

- 把低分钟收益率组平均分钟价格分歧度作为因子
- 构造方式：每天，对于每一支股票，按照分钟收益率排序，挑选这一值TAIL20%的分钟，计算这些分钟的[P01,P99]缩尾后价格买方平均分钟分歧度
   
<img width="1125" height="798" alt="image" src="https://github.com/user-attachments/assets/24ceb278-830e-4fab-b035-3a5841fe5daf" />

<img width="1126" height="798" alt="image" src="https://github.com/user-attachments/assets/fb6f3816-6837-4b84-abd9-d8422fd25a6c" />



- 把高分钟收益率组平均分钟价格分歧度作为因子 
- 构造方式：每天，对于每一支股票，按照分钟收益率排序，挑选这一值TOP20%的分钟，计算这些分钟的[P01,P99]缩尾后价格买方平均分钟分歧度 
<img width="1131" height="799" alt="image" src="https://github.com/user-attachments/assets/8cc4e2b1-d076-45ff-8e3b-fd578df2a10e" />

<img width="1125" height="797" alt="image" src="https://github.com/user-attachments/assets/95d52d00-9277-4b7b-b1d8-5423903e8acf" />



##### 卖方因子与收益率的分组结果

- 把低分钟收益率组平均分钟分歧度作为因子     
- 构造方式：每天，对于每一支股票，按照分钟收益率排序，挑选这一值TAIL20%的分钟，计算这些分钟的[P01,P99]缩尾后价格卖方平均分钟分歧度 
<img width="1126" height="796" alt="image" src="https://github.com/user-attachments/assets/b010ad93-c616-4467-a3b5-22a670bdfed6" />

<img width="1125" height="798" alt="image" src="https://github.com/user-attachments/assets/1e6c9de2-ce3d-45cb-a9ca-75b8c2c7c9b0" />


- 把高分钟收益率组平均分钟价格分歧度作为因子 
- 构造方式：每天，对于每一支股票，按照分钟收益率排序，挑选这一值TOP20%的分钟，计算这些分钟的[P01,P99]缩尾后价格卖方平均分钟分歧度
<img width="1124" height="796" alt="image" src="https://github.com/user-attachments/assets/52ade3ba-76f5-4c38-8ba7-225119468daa" />
<img width="1129" height="799" alt="image" src="https://github.com/user-attachments/assets/450faef9-7e8d-4975-b2f9-2b25d6c6adfa" />



- 把低价格分歧度组平均分钟收益率作为因子     
- 构造方式：每天，对于每一支股票，按照卖方[P01,P99]缩尾后价格平均分钟分歧度排序，挑选这一值TAIL20%的分钟，计算这些分钟的平均分钟收益率
<img width="1126" height="786" alt="image" src="https://github.com/user-attachments/assets/71925605-1c6c-4023-8ceb-8ba338b24e28" />

<img width="1128" height="796" alt="image" src="https://github.com/user-attachments/assets/25cea7e7-2366-4cba-892f-e1dfd46413a2" />


- 把高价格分歧度组平均分钟收益率作为因子     
- 构造方式：每天，对于每一支股票，按照卖方[P01,P99]缩尾后价格平均分钟分歧度排序，挑选这一值TOP20%的分钟，计算这些分钟的平均分钟收益率
<img width="1126" height="793" alt="image" src="https://github.com/user-attachments/assets/15abc53c-deb9-491b-b267-823fe517e7d1" />
<img width="1129" height="799" alt="image" src="https://github.com/user-attachments/assets/79063204-0541-49f5-b88d-1c0e5e2cfe6a" />




#### 分钟频[P01,P99]缩尾委托买单APB与分钟频收益率的分组切割因子
- 把高分钟apb组平均分钟收益率作为因子     
- 构造方式：每天，对于每一支股票，按照用缩尾后价格计算的分钟APB值排序，挑选这一值TOP20%的分钟，计算这些分钟的平均分钟收益率
<img width="1126" height="800" alt="image" src="https://github.com/user-attachments/assets/5615411c-a2b9-4956-b234-fe46951f69fd" />

<img width="1128" height="796" alt="image" src="https://github.com/user-attachments/assets/38dd84ba-241d-48a7-b0af-0bee522fd5e9" />


- 把高分钟收益率组平均分钟APB作为因子     
- 构造方式：每天，对于每一支股票，按照分钟收益率，挑选这一值TOP20%的分钟，计算这些分钟的平均分钟APB值
<img width="1125" height="797" alt="image" src="https://github.com/user-attachments/assets/adb05f09-9819-4074-83a3-ee0dc5f5022a" />
<img width="1128" height="786" alt="image" src="https://github.com/user-attachments/assets/11121c78-50ed-419c-8f96-aceeba65e64b" />



### 分钟频因子与分钟频收益率的相关性因子

#### 分钟频委托买单APB与分钟频收益率的相关性因子    
- 构造方式：对于每一支股票，计算每天它的分钟缩尾分钟APB序列与对应的分钟收益率序列的相关性，作为那一天该股票的因子值
<img width="1120" height="797" alt="image" src="https://github.com/user-attachments/assets/6e17c154-4827-4d44-a198-755eddf1afa6" />

<img width="1125" height="796" alt="image" src="https://github.com/user-attachments/assets/cdb27919-bb99-45f3-9551-86da872eff6b" />




#### 买方分歧度因子最终构造方式

- 合成方式：10：00-14：30时间段的20d滚动买方分歧度因子

<details>
<summary>因子回填</summary>
<img width="1124" height="794" alt="image" src="https://github.com/user-attachments/assets/a1483220-f88e-4cc2-aea4-afcb164ac0b7" />
<img width="1123" height="796" alt="image" src="https://github.com/user-attachments/assets/ebeefddc-5a70-42d4-8a8e-61bd908c5ab6" />


</details>


<details>
<summary>增量测试</summary>
<img width="718" height="851" alt="image" src="https://github.com/user-attachments/assets/f9f59988-4f1e-451b-91a3-290706627100" />

</details>



<img width="1127" height="796" alt="image" src="https://github.com/user-attachments/assets/38919369-4b36-4241-8e04-77121ee96fcd" />
<img width="1131" height="805" alt="image" src="https://github.com/user-attachments/assets/acc9c922-29ca-4a92-b532-436d2b842bf8" />
<img width="681" height="848" alt="image" src="https://github.com/user-attachments/assets/5a359bf2-9d2b-4ac9-a267-352d1d2a3d61" />


<img width="1135" height="804" alt="image" src="https://github.com/user-attachments/assets/fa394b3f-8b11-44c0-93e6-4db6785c7379" />
<img width="1133" height="802" alt="image" src="https://github.com/user-attachments/assets/aa455c95-aaf0-4a8c-a320-4c0963e22a79" />
<img width="701" height="840" alt="image" src="https://github.com/user-attachments/assets/fbf46f88-1e22-4bb1-abc3-4804ea934d23" />


<img width="1126" height="792" alt="image" src="https://github.com/user-attachments/assets/cbaa7fe3-1837-4b37-aaa0-903b5ffa6c06" />
<img width="1125" height="801" alt="image" src="https://github.com/user-attachments/assets/53deb68f-6cc0-4b3b-ad4e-8b050d64e706" />
<img width="716" height="851" alt="image" src="https://github.com/user-attachments/assets/875e991f-5f73-48e2-8376-7535d99363f7" />

<img width="696" height="848" alt="image" src="https://github.com/user-attachments/assets/03e6db2a-99cd-4360-8ff9-f24b6f2e6e32" />

